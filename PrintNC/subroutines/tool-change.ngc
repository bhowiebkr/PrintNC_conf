O<tool-change> SUB
( PrintNC Manual Tool Change Subroutine v1.2 )
( Enhanced with safety features, error handling, and probe reliability )
(
( USAGE:
( - M6: Manual tool change with automatic height adjustment
( - M600: Initialize tool measurement system (run before first M6)
(
( WORKFLOW:
( 1. Touch off workpiece with reference tool (T99 recommended)
( 2. Run M600 to initialize system
( 3. Run M6 T99 to establish reference tool height
( 4. Program M6 commands will prompt for tool change and auto-measure
(
( SAFETY FEATURES:
( - Feed override protection, spindle/probe checks, retry logic
( - Enhanced error messages and bounds checking
(

( CONFIGURATION PARAMETERS )
( Machine coordinates and travel )
#<_UseInches> =        0       ( 0=millimeters, 1=inches )
#<_TravelZ> =         -1       ( safe Z travel height )
#<_TravelFeed> =    1500.0     ( Z travel feedrate )
#<_ToolChangeX> =    300       ( tool change X position )
#<_ToolChangeY> =     30       ( tool change Y position )

( Probe sensor coordinates and settings )
#<_ProbeX> =        354.5      ( tool sensor X position )
#<_ProbeY> =        368.9      ( tool sensor Y position )
#<_ProbeFastZ> =      -1       ( initial probe approach Z )
#<_ProbeMinZ> =     -120       ( maximum probe depth )
#<_ProbeRetract> =   1.5       ( probe retract distance )

( Probe speeds )
#<_ProbeFastFeed> = 1000.0     ( fast probe feedrate )
#<_ProbeFeed1> =     600.0     ( coarse probe feedrate )
#<_ProbeFeed2> =      10.0     ( fine probe feedrate )

( Safety and utility settings )
#<_MistOnDuringProbe> = 0      ( 0=off, 1=mist, 2=coolant )
#<_ProbeRetries> =      3      ( probe retry attempts )
#<_MaxToolDiameter> = 25.4     ( max tool diameter safety check )

( Initialize variables if not already set )
O100 IF [EXISTS[#<_ToolDidFirst>] EQ 0]
    #<_ToolDidFirst> = 0
    #<_ToolZRef> = 0
    #<_ToolZ> = 0
    #<_ToolZLast> = 0
O100 ENDIF

O105 IF [#<_ToolDidFirst> EQ 0]
    G49                                       ( clear tool compensation )
    #<_ToolZRef> = 0
    #<_ToolZ> = 0
    #<_ToolZLast> = 0
O105 ENDIF

( Move to tool change position )
G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]       ( safe Z height )
G53 G0 X[#<_ToolChangeX>] Y[#<_ToolChangeY>]  ( tool change position )

( Execute tool change and setup )
M6                                            ( standard tool change )
M70                                           ( save modal state )
M49                                           ( disable feed override )
M9                                            ( coolant off )
M5                                            ( spindle off )

( Safety checks )
O300 IF [#5400 NE 0]                          ( spindle running check )
    (MSG, ERROR: Spindle still running - cannot probe safely)
    M2
O300 ENDIF

O301 IF [#<_ProbeX> LT -500 OR #<_ProbeX> GT 500 OR #<_ProbeY> LT -500 OR #<_ProbeY> GT 500]
    (MSG, ERROR: Probe coordinates outside safe bounds)
    M2
O301 ENDIF

( Set machine modes )
G[21 - #<_UseInches>]                         ( units: mm or inches )
G30.1                                         ( save current position )
G49                                           ( clear tool compensation )
G90                                           ( absolute positioning )
G94                                           ( feedrate per minute )
G40                                           ( radius compensation off )

( REFERENCE TOOL MEASUREMENT - First tool establishes reference height )
O200 IF [#<_ToolDidFirst> EQ 0]
    ( Move to probe position )
    G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]   ( safe Z height )
    G53 G0 X[#<_ProbeX>] Y[#<_ProbeY>]        ( above probe sensor )
    
    ( Probe safety check )
    O302 IF [#5067 EQ 1]
        (MSG, ERROR: Probe already triggered - check tool sensor)
        G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]
        M2
    O302 ENDIF
    
    ( Begin probe sequence )
    G53 G1 F[#<_ProbeFastFeed>] Z[#<_ProbeFastZ>]
    G54 G1 F[#<_ProbeFeed1>] G91              ( relative positioning )
    
    O101 IF [#<_MistOnDuringProbe> EQ 1 OR #<_MistOnDuringProbe> EQ 2]
        M[7 + #<_MistOnDuringProbe> - 1]      ( mist/coolant on )
    O101 ENDIF
  
    ( Probe with retry logic )
    #<_ProbeAttempt> = 1
    O110 WHILE [#<_ProbeAttempt> LE #<_ProbeRetries>]
        G38.2 Z[#<_ProbeMinZ> - #<_ProbeFastZ>] F[#<_ProbeFeed1>]  ( coarse probe )
        O111 IF [#5070 EQ 1]                  ( probe triggered? )
            G0 Z[#<_ProbeRetract>]            ( retract )
            G38.2 Z[#<_ProbeRetract>*-1.25] F[#<_ProbeFeed2>]  ( fine probe )
            O112 IF [#5070 EQ 1]              ( fine probe success? )
                #<_ProbeAttempt> = 999        ( exit loop )
            O112 ELSE
                (MSG, Fine probe failed - attempt #<_ProbeAttempt> of #<_ProbeRetries>)
                G0 Z[#<_ProbeRetract>]
                #<_ProbeAttempt> = [#<_ProbeAttempt> + 1]
            O112 ENDIF
        O111 ELSE
            (MSG, Coarse probe failed - attempt #<_ProbeAttempt> of #<_ProbeRetries>)
            G0 Z[#<_ProbeRetract>]
            #<_ProbeAttempt> = [#<_ProbeAttempt> + 1]
        O111 ENDIF
    O110 ENDWHILE
    
    O113 IF [#<_ProbeAttempt> NE 999]
        M9
        (MSG, PROBE FAILED after #<_ProbeRetries> attempts - Check tool sensor)
        M2
    O113 ENDIF
    
    M9                                        ( coolant off )
    G90                                       ( absolute positioning )
    #<_ToolZRef> = #5063                      ( save reference height )
    #<_ToolZLast> = #<_ToolZRef>
    
    ( Return to original position )
    G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]   ( safe Z )
    G53 G0 X[#5181] Y[#5182]                  ( original XY )
    G53 G1 F[#<_TravelFeed>] Z[#5183]         ( original Z )
    
    M72                                       ( restore modal state )
    M48                                       ( re-enable feed override )
    #<_ToolDidFirst> = 1                      ( reference established )
( TOOL CHANGE MEASUREMENT - Calculate offset from reference tool )
O200 ELSE
    G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]   ( safe Z height )
    
    ( Tool diameter handling )
    O107 IF [#<_UseInches> EQ 1]
        #<_ToolDiamIn> = #5410
        #<_ToolDiamMM> = [#<_ToolDiamIn> * 25.4]
    O107 ELSE
        #<_ToolDiamMM> = #5410
        #<_ToolDiamIn> = [#<_ToolDiamMM> / 25.4]
    O107 ENDIF
    
    ( Diameter safety check )
    O108 IF [#<_ToolDiamMM> GT #<_MaxToolDiameter>]
        (MSG, WARNING: Tool diameter #<_ToolDiamMM>mm exceeds maximum #<_MaxToolDiameter>mm)
    O108 ENDIF
    
    ( Tool change prompt )
    O102 IF [#<selected_tool> EQ 0 AND #<_ToolDiamIn> EQ 0]
        (MSG, Change tool then click Resume - Tool diameter: #<_ToolDiamMM>mm)
    O102 ELSE
        (MSG, Tool T#<selected_tool> diameter: #<_ToolDiamMM>mm)
    O102 ENDIF
    M0                                        ( pause for tool change )
 
    ( Move to probe position )
    G53 G0 X[#<_ProbeX>] Y[#<_ProbeY>]        ( above probe sensor )
    
    ( Probe safety check )
    O304 IF [#5067 EQ 1]
        (MSG, ERROR: Probe already triggered - check tool sensor)
        G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]
        M2
    O304 ENDIF
    
    ( Begin probe sequence )
    G53 G1 F[#<_ProbeFastFeed>] Z[#<_ProbeFastZ>]
    G54 G1 F[#<_ProbeFeed1>] G91              ( relative positioning )
    
    O103 IF [#<_MistOnDuringProbe> EQ 1 OR #<_MistOnDuringProbe> EQ 2]
        M[7 + #<_MistOnDuringProbe> - 1]      ( mist/coolant on )
    O103 ENDIF
  
    ( Probe with retry logic )
    #<_ProbeAttempt> = 1
    O120 WHILE [#<_ProbeAttempt> LE #<_ProbeRetries>]
        G38.2 Z[#<_ProbeMinZ> - #<_ProbeFastZ>] F[#<_ProbeFeed1>]  ( coarse probe )
        O121 IF [#5070 EQ 1]                  ( probe triggered? )
            G0 Z[#<_ProbeRetract>]            ( retract )
            G38.2 Z[#<_ProbeRetract>*-1.25] F[#<_ProbeFeed2>]  ( fine probe )
            O122 IF [#5070 EQ 1]              ( fine probe success? )
                #<_ProbeAttempt> = 999        ( exit loop )
            O122 ELSE
                (MSG, Fine probe failed - attempt #<_ProbeAttempt> of #<_ProbeRetries>)
                G0 Z[#<_ProbeRetract>]
                #<_ProbeAttempt> = [#<_ProbeAttempt> + 1]
            O122 ENDIF
        O121 ELSE
            (MSG, Coarse probe failed - attempt #<_ProbeAttempt> of #<_ProbeRetries>)
            G0 Z[#<_ProbeRetract>]
            #<_ProbeAttempt> = [#<_ProbeAttempt> + 1]
        O121 ENDIF
    O120 ENDWHILE
    
    O123 IF [#<_ProbeAttempt> NE 999]
        M9
        (MSG, PROBE FAILED after #<_ProbeRetries> attempts - Check tool sensor)
        M2
    O123 ENDIF
    
    M9                                        ( coolant off )
    G90                                       ( absolute positioning )
    #<_ToolZ> = #5063                         ( save new tool height )
    G43.1 Z[#<_ToolZ> - #<_ToolZRef>]         ( preview offset )
    
    ( Return to original position )
    G53 G1 F[#<_TravelFeed>] Z[#<_TravelZ>]   ( safe Z )
    G53 G0 X[#5181] Y[#5182]                  ( original XY )
    #<_ToolZLast> = #<_ToolZ>
    
    M72                                       ( restore modal state )
    M48                                       ( re-enable feed override )
    G43.1 Z[#<_ToolZ> - #<_ToolZRef>]         ( apply tool offset )
    
O200 ENDIF

O<tool-change> ENDSUB
M2